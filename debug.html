<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width">
<title></title>
<script type="text/javascript" src=""></script>
<script type="module">
import * as VF from "./vForth.js" 
onload =function() {
	const v = new VF.vForth()
	console.log(v.reserve)
	
	const cs = [] 
	let c 
	document.getElementById("cl").addEventListener("change", (ev)=>{
		console.log(ev.target.value )

		if( c = compile(v,ev.target.value ) ) {
			console.log(c) 
			try {
				v.run(c)
			}catch (e) {
				console.log(e)
				document.getElementById("msg").innerHTML = e.msg 
				return 
			}
			document.getElementById("msg").innerHTML = "" 
			dumpstack(v.dumpstack())
			ev.target.value=""
		}
	})
	document.getElementById("def").addEventListener("click", (ev)=>{
		const name = document.getElementById("dname").value 
		const code =  document.getElementById("dcode").value.replace(/\n/g," ")
		if(c = compile(v,code)) {
			v.adddict(name,c) 
			document.getElementById("msg").innerHTML = "define "+name 
		} 
	})
}
function compile(v,str) {
		let vv = str.split(" ")
		let vs = [] 
		for(let i=0;i<vv.length;i++) {
			let val = vv[i]
			if( val=="") continue 
			try {
				val = eval(val)
			}catch(e){
				 val = vv[i].trim() 
			}
			vs.push( val )
		}
		console.log(vs)
		let c 
		if( c = v.compile(vs) ) {
			return c 
		} else {
			document.getElementById("msg").innerHTML = v.emsg
		}	
}
function dumpstack(s) {
	document.getElementById("st").innerHTML =
		s.reverse().reduce((a,c)=>{
			let v 
			switch(c.type) {
				case "v":
					v = "["+c.value+"]"
					break
				case "m":
					v = "["+c.value.reduce((a,v)=>a+"["+v.join()+"]","")+"]"
					break
				case "n":
					v = c.value 
					break 
				case "b":
					v = "<"+c.value+">" 
					break 
				case "s":
					v = "'"+c.value+"'"
					break
			}
			return a +v+"\n" 
		},"")
}
</script>
<link rel="stylesheet" type="text/css" href="">
<style type="text/css">
textarea,input {
	font-family: monospace ;
	font-size:1rem ;
}
</style>
</head>
<body>
<div>
CODE: <input type=text size=100 id=cl><br/>
DEF NAME:<input type=text size=10 id=dname><br/>
CODE:
<textarea cols=80 rows=4 id=dcode></textarea><button id=def>DEF</button><br/>
</div>
<div id=msg style="height:3rem;">
</div>
<div style="display:flex">
	<div id=stack>
		<textarea id=st cols=40 rows=30>stack</textarea>
	</div>
</div>
</body>
</html>